// Børsbar — Database Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Organization ──────────────────────────────────────────

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users  User[]
  events Event[]

  @@map("organizations")
}

// ─── User (Admin / Staff) ──────────────────────────────────

enum UserRole {
  ADMIN
  STAFF
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  hashedPassword String   @map("hashed_password")
  name           String
  role           UserRole @default(STAFF)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("users")
}

// ─── Event ─────────────────────────────────────────────────

enum EventStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
}

enum PricingMode {
  STEP_BASED
  CURVE_BASED
}

model Event {
  id            String      @id @default(cuid())
  name          String
  description   String?
  status        EventStatus @default(DRAFT)
  pricingMode   PricingMode @default(STEP_BASED) @map("pricing_mode")
  pricingConfig Json        @default("{}") @map("pricing_config")
  startsAt      DateTime?   @map("starts_at")
  endsAt        DateTime?   @map("ends_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  drinks       Drink[]
  guests       Guest[]
  sales        Sale[]
  marketEvents MarketEvent[]

  @@map("events")
}

// ─── Drink ─────────────────────────────────────────────────

model Drink {
  id           String  @id @default(cuid())
  name         String
  category     String  @default("other")
  imageUrl     String? @map("image_url")
  basePrice    Int     @map("base_price") // stored in øre (1/100 NOK)
  minPrice     Int     @map("min_price")
  maxPrice     Int     @map("max_price")
  currentPrice Int     @map("current_price")
  sortOrder    Int     @default(0) @map("sort_order")
  isActive     Boolean @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  eventId String @map("event_id")
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  sales        Sale[]
  priceHistory PriceHistory[]

  @@map("drinks")
}

// ─── Guest ─────────────────────────────────────────────────

model Guest {
  id        String   @id @default(cuid())
  name      String
  cardId    String?  @map("card_id")
  email     String?
  pin       String?
  qrCode    String?  @unique @map("qr_code")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  eventId String @map("event_id")
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  sales Sale[]

  @@unique([eventId, cardId])
  @@unique([eventId, pin])
  @@map("guests")
}

// ─── Sale ──────────────────────────────────────────────────

model Sale {
  id        String   @id @default(cuid())
  pricePaid Int      @map("price_paid") // price at time of sale, in øre
  quantity  Int      @default(1)
  synced    Boolean  @default(true) // false = queued offline, pending sync
  createdAt DateTime @default(now()) @map("created_at")

  eventId String @map("event_id")
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  drinkId String @map("drink_id")
  drink   Drink  @relation(fields: [drinkId], references: [id], onDelete: Cascade)

  guestId String @map("guest_id")
  guest   Guest  @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@map("sales")
}

// ─── Price History ─────────────────────────────────────────

model PriceHistory {
  id         String   @id @default(cuid())
  price      Int // in øre
  recordedAt DateTime @default(now()) @map("recorded_at")

  drinkId String @map("drink_id")
  drink   Drink  @relation(fields: [drinkId], references: [id], onDelete: Cascade)

  @@index([drinkId, recordedAt])
  @@map("price_history")
}

// ─── Market Event ──────────────────────────────────────────

enum MarketEventType {
  HAPPY_HOUR
  MARKET_CRASH
  BULL_RUN
  SPOTLIGHT
  CHAOS
  CUSTOM
}

model MarketEvent {
  id          String          @id @default(cuid())
  type        MarketEventType
  name        String?
  modifier    Float           @default(1.0) // e.g., 0.7 for -30%
  durationSec Int             @default(300) @map("duration_sec")
  isActive    Boolean         @default(true) @map("is_active")
  triggeredAt DateTime        @default(now()) @map("triggered_at")
  expiresAt   DateTime        @map("expires_at")

  eventId String @map("event_id")
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("market_events")
}
